<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro Cl√≠nico</title>
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* Estilos base */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            transition: background-color 0.3s;
        }

        /* Modo oscuro */
        body.dark-mode {
            background-color: #333;
            color: #fff;
        }

        /* Barra de navegaci√≥n */
        .navbar {
            background-color: #2196F3;
            padding: 1rem;
            color: white;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-links button {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .nav-links button:hover {
            background: white;
            color: #2196F3;
        }

        /* Panel de b√∫squeda */
        .search-panel {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        .search-panel.active {
            display: block;
        }

        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-form input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Contenedor principal */
        .main-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        /* Secciones del formulario */
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .dark-mode .form-section {
            background-color: #444;
            border-color: #555;
        }

        /* Campos del formulario */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: white;
            transition: all 0.3s;
        }

        .dark-mode input,
        .dark-mode textarea,
        .dark-mode select {
            background-color: #555;
            color: #fff;
            border-color: #666;
        }

        /* Botones */
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        /* Barra de progreso */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background: #4CAF50;
            width: 0;
            transition: width 0.3s;
        }

        /* Mensajes de error y validaci√≥n */
        .error {
            color: #ff0000;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .invalid {
            border-color: #ff0000 !important;
        }

        /* Resultados de b√∫squeda */
        .patient-card {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .patient-card:hover {
            background: #f5f5f5;
        }

        .dark-mode .patient-card:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <!-- Barra de progreso -->
    <div class="progress-bar" id="progressBar"></div>

    <!-- Barra de navegaci√≥n -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">Sistema Cl√≠nico</div>
            <div class="nav-links">
                <button onclick="toggleSearch()">Buscar Paciente</button>
                <button onclick="showNewPatientForm()">Nuevo Paciente</button>
                <button onclick="toggleDarkMode()">üåô</button>
            </div>
        </div>
    </nav>

    <!-- Panel de b√∫squeda -->
    <div class="search-panel" id="searchPanel">
        <div class="search-form">
            <input type="text" id="searchInput" placeholder="Buscar por RUT o nombre...">
            <button onclick="searchPatients()">Buscar</button>
        </div>
        <div id="searchResults"></div>
    </div>

    <!-- Contenedor principal -->
    <div class="main-container">
        <form id="clinicalForm">
            <!-- Tu formulario existente aqu√≠ -->
        </form>
    </div>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAuUnWj4tyzWEzluB__RqW7JKGNJnLsMrA",
            authDomain: "sistema-clinico-6d42e.firebaseapp.com",
            projectId: "sistema-clinico-6d42e",
            storageBucket: "sistema-clinico-6d42e.firebasestorage.app",
            messagingSenderId: "150606305292",
            appId: "1:150606305292:web:1234fe31e3f40acbf0f629"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Funciones de navegaci√≥n
        function toggleSearch() {
            const searchPanel = document.getElementById('searchPanel');
            searchPanel.classList.toggle('active');
        }

        function showNewPatientForm() {
            document.getElementById('clinicalForm').reset();
            document.getElementById('searchPanel').classList.remove('active');
            updateProgressBar();
        }

        // Modo oscuro
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const button = document.querySelector('.nav-links button:last-child');
            button.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
        }

        // Barra de progreso
        function updateProgressBar() {
            const form = document.getElementById('clinicalForm');
            const inputs = form.querySelectorAll('input, textarea, select');
            const filledInputs = Array.from(inputs).filter(input => input.value.trim() !== '').length;
            const progress = (filledInputs / inputs.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        // B√∫squeda de pacientes
        function searchPatients() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = 'Buscando...';

            db.collection('pacientes')
                .where('rut', '>=', searchTerm)
                .where('rut', '<=', searchTerm + '\uf8ff')
                .get()
                .then((querySnapshot) => {
                    resultsDiv.innerHTML = '';
                    if (querySnapshot.empty) {
                        resultsDiv.innerHTML = 'No se encontraron resultados';
                        return;
                    }
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const card = document.createElement('div');
                        card.className = 'patient-card';
                        card.innerHTML = `
                            <h3>${data.nombre}</h3>
                            <p>RUT: ${data.rut}</p>
                            <p>Email: ${data.email}</p>
                        `;
                        card.onclick = () => loadPatientData(doc.id);
                        resultsDiv.appendChild(card);
                    });
                })
                .catch((error) => {
                    console.error("Error en la b√∫squeda: ", error);
                    resultsDiv.innerHTML = 'Error al realizar la b√∫squeda';
                });
        }

        // Cargar datos del paciente
        function loadPatientData(patientId) {
            db.collection('pacientes').doc(patientId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        Object.keys(data).forEach(key => {
                            const element = document.getElementById(key);
                            if (element) {
                                element.value = data[key];
                            }
                        });
                        document.getElementById('searchPanel').classList.remove('active');
                        updateProgressBar();
                    }
                })
                .catch((error) => {
                    console.error("Error al cargar los datos: ", error);
                    alert('Error al cargar los datos del paciente');
                });
        }

        // Validaci√≥n de RUT chileno
        function validarRut(rut) {
            if (!/^[0-9]+-[0-9kK]{1}$/.test(rut)) return false;
            let [num, dv] = rut.split('-');
            let suma = 0;
            let multiplo = 2;
            for (let i = num.length - 1; i >= 0; i--) {
                suma += num[i] * multiplo;
                multiplo = multiplo === 7 ? 2 : multiplo + 1;
            }
            const dvEsperado = 11 - (suma % 11);
            const dvReal = dv.toLowerCase();
            if (dvEsperado === 11) return dvReal === '0';
            if (dvEsperado === 10) return dvReal === 'k';
            return dvReal === dvEsperado.toString();
        }

        // Eventos
        document.addEventListener('DOMContentLoaded', () => {
            // Actualizar barra de progreso cuando se modifica el formulario
            document.getElementById('clinicalForm').addEventListener('input', updateProgressBar);

            // Validar RUT cuando se ingresa
            const rutInput = document.getElementById('rut');
            if (rutInput) {
                rutInput.addEventListener('blur', function() {
                    if (!validarRut(this.value)) {
                        this.classList.add('invalid');
                        let error = document.createElement('div');
                        error.className = 'error';
                        error.textContent = 'RUT inv√°lido';
                        this.parentNode.appendChild(error);
                    } else {
                        this.classList.remove('invalid');
                        const error = this.parentNode.querySelector('.error');
                        if (error) error.remove();
                    }
                });
            }

            // Calcular IMC autom√°ticamente
            const pesoInput = document.getElementById('peso');
            const tallaInput = document.getElementById('talla');
            if (pesoInput && tallaInput) {
                function calcularIMC() {
                    const peso = parseFloat(pesoInput.value);
                    const talla = parseFloat(tallaInput.value) / 100; // convertir a metros
                    if (peso && talla) {
                        const imc = peso / (talla * talla);
                        const imcInput = document.getElementById('imc');
                        if (imcInput) {
                            imcInput.value = imc.toFixed(2);
                        }
                    }
                }
                pesoInput.addEventListener('input', calcularIMC);
                tallaInput.addEventListener('input', calcularIMC);
            }
        });
    </script>
</body>
</html>
